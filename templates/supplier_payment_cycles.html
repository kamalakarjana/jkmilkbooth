{% extends "base.html" %}

{% block title %}Payment Cycles - {{ supplier.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="fw-bold text-dark mb-3">
                <i class="fas fa-calendar-alt text-primary"></i> Payment Cycles - {{ supplier.name }}
            </h2>
            <p class="lead text-muted">Supplier ID: {{ supplier.supplier_id }}</p>
        </div>
    </div>

    <!-- Month Selection -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-calendar"></i> Select Month
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <select name="month" class="form-select" onchange="this.form.submit()">
                        {% for month_option in month_options %}
                        <option value="{{ month_option }}" {% if month_option == selected_month %}selected{% endif %}>
                            {{ month_option }}
                        </option>
                        {% endfor %}
                        {% if month_options|length == 0 %}
                        <option value="{{ selected_month }}" selected>{{ selected_month }}</option>
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Show
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stat-card">
                <i class="fas fa-rupee-sign text-success"></i>
                <div class="number">₹ {{ total_month_amount }}</div>
                <div class="label">Total Collection ({{ selected_month }})</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <i class="fas fa-money-bill-wave text-warning"></i>
                <div class="number">₹ {{ total_withdrawn }}</div>
                <div class="label">Total Withdrawn</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <i class="fas fa-balance-scale text-info"></i>
                <div class="number">₹ {{ balance }}</div>
                <div class="label">Balance to Pay</div>
            </div>
        </div>
    </div>

    <!-- Cycle 1: 1st to 15th -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-calendar-day"></i> Cycle 1: 1st - 15th of {{ selected_month }}
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Session</th>
                            <th>Collections Count</th>
                            <th>Total Liters</th>
                            <th>Total Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Morning</strong></td>
                            <td>{{ cycles.cycle_1.morning.count }}</td>
                            <td>{{ "%.2f"|format(cycles.cycle_1.morning.liters) }} L</td>
                            <td class="fw-bold">₹ {{ cycles.cycle_1.morning.amount }}</td>
                        </tr>
                        <tr>
                            <td><strong>Evening</strong></td>
                            <td>{{ cycles.cycle_1.evening.count }}</td>
                            <td>{{ "%.2f"|format(cycles.cycle_1.evening.liters) }} L</td>
                            <td class="fw-bold">₹ {{ cycles.cycle_1.evening.amount }}</td>
                        </tr>
                        <tr class="table-success fw-bold">
                            <td><strong>Cycle 1 Total</strong></td>
                            <td>{{ cycles.cycle_1.morning.count + cycles.cycle_1.evening.count }}</td>
                            <td>{{ "%.2f"|format(cycles.cycle_1.total_liters) }} L</td>
                            <td>₹ {{ cycles.cycle_1.total_amount }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Cycle 2: 16th to End of Month -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <i class="fas fa-calendar-day"></i> Cycle 2: 16th - {{ cycles.cycle_2.end.split('-')[2] }}th of {{ selected_month }}
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Session</th>
                            <th>Collections Count</th>
                            <th>Total Liters</th>
                            <th>Total Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Morning</strong></td>
                            <td>{{ cycles.cycle_2.morning.count }}</td>
                            <td>{{ "%.2f"|format(cycles.cycle_2.morning.liters) }} L</td>
                            <td class="fw-bold">₹ {{ cycles.cycle_2.morning.amount }}</td>
                        </tr>
                        <tr>
                            <td><strong>Evening</strong></td>
                            <td>{{ cycles.cycle_2.evening.count }}</td>
                            <td>{{ "%.2f"|format(cycles.cycle_2.evening.liters) }} L</td>
                            <td class="fw-bold">₹ {{ cycles.cycle_2.evening.amount }}</td>
                        </tr>
                        <tr class="table-success fw-bold">
                            <td><strong>Cycle 2 Total</strong></td>
                            <td>{{ cycles.cycle_2.morning.count + cycles.cycle_2.evening.count }}</td>
                            <td>{{ "%.2f"|format(cycles.cycle_2.total_liters) }} L</td>
                            <td>₹ {{ cycles.cycle_2.total_amount }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Monthly Summary -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <i class="fas fa-chart-bar"></i> Monthly Summary - {{ selected_month }}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-bordered">
                        <tr>
                            <td><strong>Total Morning Collections:</strong></td>
                            <td>{{ cycles.cycle_1.morning.count + cycles.cycle_2.morning.count }}</td>
                        </tr>
                        <tr>
                            <td><strong>Total Evening Collections:</strong></td>
                            <td>{{ cycles.cycle_1.evening.count + cycles.cycle_2.evening.count }}</td>
                        </tr>
                        <tr>
                            <td><strong>Total Collections:</strong></td>
                            <td>{{ cycles.cycle_1.morning.count + cycles.cycle_1.evening.count + cycles.cycle_2.morning.count + cycles.cycle_2.evening.count }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-bordered">
                        <tr>
                            <td><strong>Total Liters (Month):</strong></td>
                            <td class="text-success fw-bold">{{ "%.2f"|format(cycles.cycle_1.total_liters + cycles.cycle_2.total_liters) }} L</td>
                        </tr>
                        <tr>
                            <td><strong>Total Amount (Month):</strong></td>
                            <td class="text-primary fw-bold">₹ {{ cycles.cycle_1.total_amount + cycles.cycle_2.total_amount }}</td>
                        </tr>
                        <tr>
                            <td><strong>Average per Collection:</strong></td>
                            <td>
                                {% set total_collections = cycles.cycle_1.morning.count + cycles.cycle_1.evening.count + cycles.cycle_2.morning.count + cycles.cycle_2.evening.count %}
                                {% if total_collections > 0 %}
                                ₹ {{ ((cycles.cycle_1.total_amount + cycles.cycle_2.total_amount) / total_collections)|round(2) }}
                                {% else %}
                                ₹ 0
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="alert alert-warning mt-3">
                <i class="fas fa-info-circle"></i>
                <strong>Payment Cycles:</strong> 
                <ul class="mb-0 mt-2">
                    <li><strong>Cycle 1:</strong> 1st to 15th of each month</li>
                    <li><strong>Cycle 2:</strong> 16th to last day of each month</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-4 d-flex justify-content-between">
        <div>
            <a href="{{ url_for('supplier_view', supplier_id=supplier.supplier_id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Supplier Details
            </a>
            <a href="{{ url_for('suppliers') }}" class="btn btn-outline-secondary">
                <i class="fas fa-users"></i> All Suppliers
            </a>
        </div>
        <div>
            {% if current_user.role in ['admin', 'employee'] %}
            <a href="{{ url_for('monthly') }}?month={{ selected_month }}" class="btn btn-primary">
                <i class="fas fa-calendar-alt"></i> Monthly Report
            </a>
            <button class="btn btn-warning" onclick="printDiv()">
                <i class="fas fa-print"></i> Print Report
            </button>
            {% endif %}
        </div>
    </div>
</div>

<script>
function printDiv() {
    var printContents = document.querySelector('.container-fluid').innerHTML;
    var originalContents = document.body.innerHTML;
    
    document.body.innerHTML = `
        <html>
            <head>
                <title>Payment Cycles - {{ supplier.name }} - {{ selected_month }}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .card { border: 1px solid #ddd; margin-bottom: 20px; }
                    .card-header { background: #f8f9fa; padding: 10px; font-weight: bold; }
                    .table { width: 100%; border-collapse: collapse; }
                    .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    .table-success { background-color: #d4edda; }
                    .text-center { text-align: center; }
                    .fw-bold { font-weight: bold; }
                </style>
            </head>
            <body>
                <h2>Payment Cycles - {{ supplier.name }}</h2>
                <p>Supplier ID: {{ supplier.supplier_id }} | Month: {{ selected_month }}</p>
                ${printContents}
            </body>
        </html>
    `;
    
    window.print();
    document.body.innerHTML = originalContents;
    location.reload();
}
</script>
{% endblock %}