<!doctype html>
<html>
<head>
  <title>Daily Collections - {{ date }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-card .number {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
    }
    .session-btn.active {
      background-color: #0d6efd;
      color: white;
    }
    .table th {
      background-color: #2c3e50;
      color: white;
    }
    .no-collection {
      color: #999;
      font-style: italic;
    }
    /* Sort button styling */
    .sortable-header {
      cursor: pointer;
      position: relative;
    }
    .sortable-header:hover {
      background-color: #34495e !important;
    }
    .sort-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }
    .supplier-id {
      font-weight: bold;
      color: #2c3e50;
    }
    /* Rate period badge */
    .rate-period-badge {
      font-size: 0.7rem;
      margin-left: 5px;
      vertical-align: middle;
    }
  </style>
</head>
<body class="p-3">
<div class="container">
  <h3 class="mb-3">
    <i class="fas fa-calendar-day text-primary"></i> Daily Collections — {{ date }}
    {% if date >= NEW_RATES_START_DATE %}
    <span class="badge bg-info rate-period-badge">New Buffalo Rates Period (Feb 2026+)</span>
    {% else %}
    <span class="badge bg-secondary rate-period-badge">Old Buffalo Rates Period</span>
    {% endif %}
  </h3>
  
  <!-- Statistics Row -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <i class="fas fa-weight text-primary mb-2"></i>
        <div class="number">{{ "%.2f"|format(total_liters) }}</div>
        <div class="text-muted">Total Liters</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <i class="fas fa-rupee-sign text-success mb-2"></i>
        <div class="number">₹ {{ total_amount }}</div>
        <div class="text-muted">Total Amount</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <i class="fas fa-percentage text-warning mb-2"></i>
        <div class="number">{{ "%.1f"|format(avg_fat) }}%</div>
        <div class="text-muted">Average Fat</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <i class="fas fa-list text-info mb-2"></i>
        <div class="number">{{ rows|selectattr('id')|list|length }}</div>
        <div class="text-muted">Collections</div>
      </div>
    </div>
  </div>
  
  <!-- Date and Filter Controls -->
  <div class="row mb-3">
    <div class="col-md-4">
      <form method="get" class="d-flex">
        <input type="date" name="date" value="{{ date }}" class="form-control me-2">
        <button class="btn btn-primary">
          <i class="fas fa-calendar-alt"></i> Show
        </button>
      </form>
    </div>
    <div class="col-md-8">
      <div class="btn-group float-end">
        <a href="{{ url_for('daily', date=date, session='all') }}" 
           class="btn btn-outline-primary {% if session_filter == 'all' %}active{% endif %}">
          All Suppliers
        </a>
        <a href="{{ url_for('daily', date=date, session='morning') }}" 
           class="btn btn-outline-primary {% if session_filter == 'morning' %}active{% endif %}">
          <i class="fas fa-sun"></i> Morning Only
        </a>
        <a href="{{ url_for('daily', date=date, session='evening') }}" 
           class="btn btn-outline-primary {% if session_filter == 'evening' %}active{% endif %}">
          <i class="fas fa-moon"></i> Evening Only
        </a>
      </div>
    </div>
  </div>
  
  <!-- Action Buttons -->
  <div class="mb-3">
    <a href="{{ url_for('add_collection_page') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Add New Collection
    </a>
    <a href="{{ url_for('quick_add_page') }}" class="btn btn-warning">
      <i class="fas fa-bolt"></i> Quick Add
    </a>
    <a href="{{ url_for('sales') }}" class="btn btn-success">
      <i class="fas fa-shopping-cart"></i> Sales
    </a>
    
    <!-- NEW: Refresh Rates Button (only for Feb 2026+ dates) -->
    {% if current_user.role in ['admin'] and date >= NEW_RATES_START_DATE %}
    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#refreshRatesModal">
      <i class="fas fa-sync-alt"></i> Refresh Buffalo Rates
    </button>
    {% endif %}
  </div>
  
  <!-- Collections Table (No # column) -->
  <div class="table-responsive">
    <table class="table table-hover table-striped" id="daily-collections">
      <thead>
        <tr>
          <th class="sortable-header" onclick="sortTable('supplier-id', 'smart-numeric')">
            Supplier ID <i class="fas fa-sort sort-icon"></i>
          </th>
          <th class="sortable-header" onclick="sortTable('supplier-name', 'text')">
            Name <i class="fas fa-sort sort-icon"></i>
          </th>
          <th>Type</th>
          <th>Session</th>
          <th class="sortable-header" onclick="sortTable('liters', 'number')">
            Liters <i class="fas fa-sort sort-icon"></i>
          </th>
          <th class="sortable-header" onclick="sortTable('fat', 'number')">
            Fat % <i class="fas fa-sort sort-icon"></i>
          </th>
          <th class="sortable-header" onclick="sortTable('amount', 'number')">
            Amount <i class="fas fa-sort sort-icon"></i>
          </th>
          {% if current_user.role in ['admin', 'employee'] %}
          <th class="sortable-header" onclick="sortTable('rate', 'number')">
            Rate/L <i class="fas fa-sort sort-icon"></i>
          </th>
          <th>Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody id="table-body">
        {% for r in rows %}
        <tr class="{% if not r.id %}no-collection{% endif %}">
          <td class="supplier-id" data-supplier-id="{{ r.supplier.supplier_id }}" data-sort-type="smart-numeric">
            <strong>{{ r.supplier.supplier_id }}</strong>
          </td>
          <td data-sort-type="text">{{ r.supplier.name }}</td>
          <td>
            {% if r.milk_type %}
            <span class="badge {% if r.milk_type == 'cow' %}bg-info{% else %}bg-warning{% endif %}">
              {{ r.milk_type|title }}
              {% if r.milk_type == 'buffalo' and date >= NEW_RATES_START_DATE %}
              <span class="badge bg-dark" title="New rates from Feb 2026">NEW</span>
              {% endif %}
            </span>
            {% else %}
            <span class="badge bg-secondary">No Data</span>
            {% endif %}
          </td>
          <td>
            {% if r.session %}
            <span class="badge {% if r.session == 'morning' %}bg-warning{% else %}bg-info{% endif %}">
              {{ r.session|title }}
            </span>
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td data-sort-value="{{ r.liters }}" data-sort-type="number">
            {% if r.liters > 0 %}
            {{ "%.2f"|format(r.liters) }}
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td data-sort-value="{{ r.fat }}" data-sort-type="number">
            {% if r.fat > 0 %}
            {{ "%.1f"|format(r.fat) }}
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td data-sort-value="{{ r.amount }}" data-sort-type="number">
            {% if r.amount > 0 %}
            <strong>₹ {{ r.amount }}</strong>
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          {% if current_user.role in ['admin', 'employee'] %}
          <td data-sort-value="{{ r.rate_per_liter }}" data-sort-type="number">
            {% if r.rate_per_liter > 0 %}
            {{ "%.2f"|format(r.rate_per_liter) }}
            {% if r.milk_type == 'buffalo' %}
            <small class="text-muted d-block">
              {% if date >= NEW_RATES_START_DATE %}
              <span class="badge bg-success">New Rate</span>
              {% else %}
              <span class="badge bg-secondary">Old Rate</span>
              {% endif %}
            </small>
            {% endif %}
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>
            {% if r.id %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_collection', cid=r.id) }}">
              <i class="fas fa-edit"></i>
            </a>
            <form method="post" action="{{ url_for('delete_collection', cid=r.id) }}" 
                  style="display:inline" onsubmit="return confirm('Delete this collection?')">
              <button class="btn btn-sm btn-danger">
                <i class="fas fa-trash"></i>
              </button>
            </form>
            {% else %}
            <a href="{{ url_for('quick_add_page') }}?supplier_id={{ r.supplier.supplier_id }}&date={{ date }}" 
               class="btn btn-sm btn-success">
              <i class="fas fa-plus"></i> Add
            </a>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% else %}
        <tr>
          <td colspan="{% if current_user.role in ['admin', 'employee'] %}9{% else %}7{% endif %}" class="text-center py-4">
            <div class="text-muted">
              <i class="fas fa-inbox fa-2x mb-3"></i>
              <p>No suppliers found</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div class="mt-3">
    <a href="{{ url_for('add_collection_page') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Add Collection
    </a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>
</div>

<!-- Refresh Rates Modal -->
<div class="modal fade" id="refreshRatesModal" tabindex="-1" aria-labelledby="refreshRatesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="refreshRatesModalLabel">
          <i class="fas fa-sync-alt text-info me-2"></i>Refresh Buffalo Milk Rates for {{ date }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Warning:</strong> This action will recalculate rates for <strong>buffalo milk collections only</strong> on {{ date }} using new rates (from February 2026).
        </div>
        
        <p><strong>What will happen:</strong></p>
        <ul>
          <li>✅ <strong>Buffalo milk rates</strong> will be updated to new 2026 rates</li>
          <li>✅ Amounts will be recalculated for buffalo milk</li>
          <li>⏺️ <strong>Cow milk rates will NOT change</strong> (same as before)</li>
          <li>⚠️ This will affect supplier balances</li>
        </ul>
        
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          Only collections from <strong>February 1, 2026 onwards</strong> can be updated. Cow milk rates remain unchanged.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{{ url_for('refresh_daily_rates', date=date) }}" id="refreshForm">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Refresh Buffalo Rates Now
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Smart numeric sorting function that handles mixed IDs (like 1, 2, 10, C001, T1)
function smartNumericSort(a, b) {
  // Try to parse as numbers first
  const aNum = parseFloat(a);
  const bNum = parseFloat(b);
  
  // If both are valid numbers, sort numerically
  if (!isNaN(aNum) && !isNaN(bNum)) {
    return aNum - bNum;
  }
  
  // If one is a number and the other isn't, numbers come first
  if (!isNaN(aNum) && isNaN(bNum)) {
    return -1; // a (number) comes before b (non-number)
  }
  if (isNaN(aNum) && !isNaN(bNum)) {
    return 1; // b (number) comes before a (non-number)
  }
  
  // Both are non-numbers, sort alphabetically
  return a.toString().localeCompare(b.toString());
}

// Sort table on page load by Supplier ID (smart numeric)
document.addEventListener('DOMContentLoaded', function() {
  // Initially sort by Supplier ID using smart numeric sorting
  sortTableBody('supplier-id', 'smart-numeric');
  
  // Add active state to the Supplier ID header
  const headers = document.querySelectorAll('.sortable-header');
  headers.forEach(header => {
    if (header.textContent.includes('Supplier ID')) {
      header.classList.add('active');
      // Update sort icon
      const icon = header.querySelector('.sort-icon');
      if (icon) {
        icon.className = 'fas fa-sort-down sort-icon';
      }
    }
  });
});

function getCellValue(row, columnType) {
  if (columnType === 'supplier-id') {
    return row.querySelector('.supplier-id').getAttribute('data-supplier-id') || '';
  } else if (columnType === 'supplier-name') {
    const cell = row.querySelector('td:nth-child(2)');
    return cell ? cell.textContent.trim() : '';
  } else if (columnType === 'liters') {
    const cell = row.querySelector('td:nth-child(5)');
    return cell ? parseFloat(cell.getAttribute('data-sort-value') || 0) : 0;
  } else if (columnType === 'fat') {
    const cell = row.querySelector('td:nth-child(6)');
    return cell ? parseFloat(cell.getAttribute('data-sort-value') || 0) : 0;
  } else if (columnType === 'amount') {
    const cell = row.querySelector('td:nth-child(7)');
    return cell ? parseFloat(cell.getAttribute('data-sort-value') || 0) : 0;
  } else if (columnType === 'rate') {
    const cell = row.querySelector('td:nth-child(8)');
    return cell ? parseFloat(cell.getAttribute('data-sort-value') || 0) : 0;
  }
  return '';
}

function sortTableBody(columnType, sortType) {
  const tbody = document.getElementById('table-body');
  const rows = Array.from(tbody.querySelectorAll('tr:not(.no-data-row)'));
  
  // Determine sort direction
  const header = document.querySelector(`.sortable-header[onclick*="${columnType}"]`);
  const isCurrentlyActive = header.classList.contains('active');
  let isAscending = true;
  
  if (isCurrentlyActive) {
    // Toggle direction if already active
    const currentDirection = header.getAttribute('data-sort-dir') || 'asc';
    isAscending = currentDirection === 'asc' ? false : true;
    header.setAttribute('data-sort-dir', isAscending ? 'asc' : 'desc');
  } else {
    // Remove active state from all headers
    document.querySelectorAll('.sortable-header').forEach(h => {
      h.classList.remove('active');
      h.removeAttribute('data-sort-dir');
      const icon = h.querySelector('.sort-icon');
      if (icon) {
        icon.className = 'fas fa-sort sort-icon';
      }
    });
    
    // Set active state for clicked header
    header.classList.add('active');
    header.setAttribute('data-sort-dir', 'asc');
  }
  
  // Update sort icon
  const icon = header.querySelector('.sort-icon');
  if (icon) {
    icon.className = isAscending ? 'fas fa-sort-down sort-icon' : 'fas fa-sort-up sort-icon';
  }
  
  // Sort rows
  rows.sort((rowA, rowB) => {
    const valueA = getCellValue(rowA, columnType);
    const valueB = getCellValue(rowB, columnType);
    
    let comparison = 0;
    
    if (sortType === 'smart-numeric') {
      comparison = smartNumericSort(valueA, valueB);
    } else if (sortType === 'number') {
      comparison = (parseFloat(valueA) || 0) - (parseFloat(valueB) || 0);
    } else if (sortType === 'text') {
      comparison = valueA.toString().localeCompare(valueB.toString());
    }
    
    // Reverse if descending
    return isAscending ? comparison : -comparison;
  });
  
  // Reorder rows in tbody
  tbody.innerHTML = '';
  rows.forEach(row => {
    tbody.appendChild(row);
  });
}

function sortTable(columnType, sortType) {
  sortTableBody(columnType, sortType);
}
</script>
</body>
</html>