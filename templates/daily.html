<!doctype html>
<html>
<head>
  <title>Daily Collections - {{ date }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #8B4513;
      --secondary: #D4AF37;
      --accent: #2E8B57;
      --light: #FFF8DC;
      --dark: #5D4037;
      --light-brown: #A0522D;
      --background: #f9f5f0;
      --card-bg: white;
      --text: #212529;
      --text-muted: #6c757d;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
    }
    
    body {
      background-color: var(--background);
      color: var(--text);
      font-family: 'Roboto', sans-serif;
    }
    
    .stat-card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-card .number {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--dark);
    }
    .stat-card i.text-primary { color: var(--primary) !important; }
    .stat-card i.text-success { color: var(--success) !important; }
    .stat-card i.text-warning { color: var(--warning) !important; }
    .stat-card i.text-info { color: var(--info) !important; }
    
    .session-btn.active {
      background-color: var(--primary) !important;
      color: white;
    }
    
    .table th {
      background: linear-gradient(135deg, var(--dark), var(--primary));
      color: white;
    }
    
    .no-collection {
      color: var(--text-muted);
      font-style: italic;
    }
    
    .badge.bg-warning { background-color: var(--warning) !important; }
    .badge.bg-info { background-color: var(--info) !important; }
    .badge.bg-success { background-color: var(--success) !important; }
    .badge.bg-secondary { background-color: var(--text-muted) !important; }
    .badge.bg-dark { background-color: var(--dark) !important; }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--dark));
        border: none;
        color: white;
    }
    
    .btn-warning {
        background: linear-gradient(135deg, var(--warning), #e6b800);
        border: none;
        color: #212529;
    }
    
    .btn-success {
        background: linear-gradient(135deg, var(--success), #219653);
        border: none;
        color: white;
    }
    
    .btn-info {
        background: linear-gradient(135deg, var(--info), #117a8b);
        border: none;
        color: white;
    }
    
    .btn-outline-primary {
        border: 2px solid var(--primary);
        color: var(--primary);
    }
    
    .btn-outline-primary:hover {
        background: var(--primary);
        color: white;
    }
    
    .modal-header.bg-info {
        background: linear-gradient(135deg, var(--info), #117a8b) !important;
    }
    
    .alert-warning {
        border-left: 5px solid var(--warning);
    }
    
    .alert-info {
        border-left: 5px solid var(--info);
    }
    
    /* Sort button styling */
    .sortable-header {
      cursor: pointer;
      position: relative;
    }
    .sortable-header:hover {
      background-color: var(--dark) !important;
    }
    .sort-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }
    .supplier-id {
      font-weight: bold;
      color: var(--dark);
    }
    /* Rate period badge */
    .rate-period-badge {
      font-size: 0.7rem;
      margin-left: 5px;
      vertical-align: middle;
    }
  </style>
</head>
<body class="p-3">
<div class="container">
  <h3 class="mb-3">
    <i class="fas fa-calendar-day" style="color: var(--primary);"></i> Daily Collections — {{ date }}
    {% if date >= NEW_RATES_START_DATE %}
    <span class="badge bg-info rate-period-badge">New Buffalo Rates Period (Feb 2026+)</span>
    {% else %}
    <span class="badge bg-secondary rate-period-badge">Old Buffalo Rates Period</span>
    {% endif %}
  </h3>
  
  <!-- Statistics Row -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <i class="fas fa-weight text-primary mb-2"></i>
        <div class="number">{{ "%.2f"|format(total_liters) }}</div>
        <div class="text-muted">Total Liters</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <i class="fas fa-rupee-sign text-success mb-2"></i>
        <div class="number">₹ {{ total_amount }}</div>
        <div class="text-muted">Total Amount</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <i class="fas fa-percentage text-warning mb-2"></i>
        <div class="number">{{ "%.1f"|format(avg_fat) }}%</div>
        <div class="text-muted">Average Fat</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <i class="fas fa-list text-info mb-2"></i>
        <div class="number">{{ rows|selectattr('id')|list|length }}</div>
        <div class="text-muted">Collections</div>
      </div>
    </div>
  </div>
  
  <!-- Date and Filter Controls -->
  <div class="row mb-3">
    <div class="col-md-4">
      <form method="get" class="d-flex">
        <input type="date" name="date" value="{{ date }}" class="form-control me-2">
        <button class="btn btn-primary">
          <i class="fas fa-calendar-alt"></i> Show
        </button>
      </form>
    </div>
    <div class="col-md-8">
      <div class="btn-group float-end">
        <a href="{{ url_for('daily', date=date, session='all') }}" 
           class="btn btn-outline-primary {% if session_filter == 'all' %}active{% endif %}">
          All Suppliers
        </a>
        <a href="{{ url_for('daily', date=date, session='morning') }}" 
           class="btn btn-outline-primary {% if session_filter == 'morning' %}active{% endif %}">
          <i class="fas fa-sun"></i> Morning Only
        </a>
        <a href="{{ url_for('daily', date=date, session='evening') }}" 
           class="btn btn-outline-primary {% if session_filter == 'evening' %}active{% endif %}">
          <i class="fas fa-moon"></i> Evening Only
        </a>
      </div>
    </div>
  </div>
  
  <!-- Action Buttons -->
  <div class="mb-3">
    <a href="{{ url_for('add_collection_page') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Add New Collection
    </a>
    <a href="{{ url_for('quick_add_page') }}" class="btn btn-warning">
      <i class="fas fa-bolt"></i> Quick Add
    </a>
    <a href="{{ url_for('sales') }}" class="btn btn-success">
      <i class="fas fa-shopping-cart"></i> Sales
    </a>
    
    <!-- NEW: Refresh Rates Button (only for Feb 2026+ dates) -->
    {% if current_user.role in ['admin'] and date >= NEW_RATES_START_DATE %}
    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#refreshRatesModal">
      <i class="fas fa-sync-alt"></i> Refresh Buffalo Rates
    </button>
    {% endif %}
  </div>
  
  <!-- Collections Table (No # column) -->
  <div class="table-responsive">
    <table class="table table-hover table-striped" id="daily-collections">
      <thead>
        <tr>
          <th class="sortable-header" onclick="sortTable('supplier-id', 'smart-numeric')">
            Supplier ID <i class="fas fa-sort sort-icon"></i>
          </th>
          <th class="sortable-header" onclick="sortTable('supplier-name', 'text')">
            Name <i class="fas fa-sort sort-icon"></i>
          </th>
          <th>Type</th>
          <th>Session</th>
          <th class="sortable-header" onclick="sortTable('liters', 'number')">
            Liters <i class="fas fa-sort sort-icon"></i>
          </th>
          <th class="sortable-header" onclick="sortTable('fat', 'number')">
            Fat % <i class="fas fa-sort sort-icon"></i>
          </th>
          <th class="sortable-header" onclick="sortTable('amount', 'number')">
            Amount <i class="fas fa-sort sort-icon"></i>
          </th>
          {% if current_user.role in ['admin', 'employee'] %}
          <th class="sortable-header" onclick="sortTable('rate', 'number')">
            Rate/L <i class="fas fa-sort sort-icon"></i>
          </th>
          <th>Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody id="table-body">
        {% for r in rows %}
        <tr class="{% if not r.id %}no-collection{% endif %}">
          <td class="supplier-id" data-supplier-id="{{ r.supplier.supplier_id }}" data-sort-type="smart-numeric">
            <strong>{{ r.supplier.supplier_id }}</strong>
          </td>
          <td data-sort-type="text">{{ r.supplier.name }}</td>
          <td>
            {% if r.milk_type %}
            <span class="badge {% if r.milk_type == 'cow' %}bg-info{% else %}bg-warning{% endif %}">
              {{ r.milk_type|title }}
              {% if r.milk_type == 'buffalo' and date >= NEW_RATES_START_DATE %}
              <span class="badge bg-dark" title="New rates from Feb 2026">NEW</span>
              {% endif %}
            </span>
            {% else %}
            <span class="badge bg-secondary">No Data</span>
            {% endif %}
          </td>
          <td>
            {% if r.session %}
            <span class="badge {% if r.session == 'morning' %}bg-warning{% else %}bg-info{% endif %}">
              {{ r.session|title }}
            </span>
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td data-sort-value="{{ r.liters }}" data-sort-type="number">
            {% if r.liters > 0 %}
            {{ "%.2f"|format(r.liters) }}
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td data-sort-value="{{ r.fat }}" data-sort-type="number">
            {% if r.fat > 0 %}
            {{ "%.1f"|format(r.fat) }}
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td data-sort-value="{{ r.amount }}" data-sort-type="number">
            {% if r.amount > 0 %}
            <strong>₹ {{ r.amount }}</strong>
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          {% if current_user.role in ['admin', 'employee'] %}
          <td data-sort-value="{{ r.rate_per_liter }}" data-sort-type="number">
            {% if r.rate_per_liter > 0 %}
            {{ "%.2f"|format(r.rate_per_liter) }}
            {% if r.milk_type == 'buffalo' %}
            <small class="text-muted d-block">
              {% if date >= NEW_RATES_START_DATE %}
              <span class="badge bg-success">New Rate</span>
              {% else %}
              <span class="badge bg-secondary">Old Rate</span>
              {% endif %}
            </small>
            {% endif %}
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>
            {% if r.id %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_collection', cid=r.id) }}">
              <i class="fas fa-edit"></i>
            </a>
            <form method="post" action="{{ url_for('delete_collection', cid=r.id) }}" 
                  style="display:inline" onsubmit="return confirm('Delete this collection?')">
              <button class="btn btn-sm btn-danger">
                <i class="fas fa-trash"></i>
              </button>
            </form>
            {% else %}
            <a href="{{ url_for('quick_add_page') }}?supplier_id={{ r.supplier.supplier_id }}&date={{ date }}" 
               class="btn btn-sm btn-success">
              <i class="fas fa-plus"></i> Add
            </a>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% else %}
        <tr>
          <td colspan="{% if current_user.role in ['admin', 'employee'] %}9{% else %}7{% endif %}" class="text-center py-4">
            <div class="text-muted">
              <i class="fas fa-inbox fa-2x mb-3"></i>
              <p>No suppliers found</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div class="mt-3">
    <a href="{{ url_for('add_collection_page') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Add Collection
    </a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>
</div>

<!-- Refresh Rates Modal -->
<div class="modal fade" id="refreshRatesModal" tabindex="-1" aria-labelledby="refreshRatesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="refreshRatesModalLabel">
          <i class="fas fa-sync-alt text-white me-2"></i>Refresh Buffalo Milk Rates for {{ date }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Warning:</strong> This action will recalculate rates for <strong>buffalo milk collections only</strong> on {{ date }} using new rates (from February 2026).
        </div>
        
        <p><strong>What will happen:</strong></p>
        <ul>
          <li>✅ <strong>Buffalo milk rates</strong> will be updated to new 2026 rates</li>
          <li>✅ Amounts will be recalculated for buffalo milk</li>
          <li>⏺️ <strong>Cow milk rates will NOT change</strong> (same as before)</li>
          <li>⚠️ This will affect supplier balances</li>
        </ul>
        
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          Only collections from <strong>February 1, 2026 onwards</strong> can be updated. Cow milk rates remain unchanged.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{{ url_for('refresh_daily_rates', date=date) }}" id="refreshForm">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Refresh Buffalo Rates Now
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load theme from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('rrMilkTheme');
    if (savedTheme) {
        const theme = JSON.parse(savedTheme);
        
        document.documentElement.style.setProperty('--primary', theme.primary);
        document.documentElement.style.setProperty('--secondary', theme.secondary);
        document.documentElement.style.setProperty('--background', theme.background);
        document.documentElement.style.setProperty('--dark', theme.dark);
        document.documentElement.style.setProperty('--light-brown', theme.lightBrown);
        
        // Set accent color based on primary
        const accent = adjustColor(theme.primary, 20);
        document.documentElement.style.setProperty('--accent', accent);
    }
    
    // Sorting function for the table
    function sortTable(column, type) {
        const table = document.getElementById('daily-collections');
        const tbody = document.getElementById('table-body');
        const rows = Array.from(tbody.getElementsByTagName('tr'));
        
        // Determine column index based on column type
        let colIndex = 0;
        switch(column) {
            case 'supplier-id': colIndex = 0; break;
            case 'supplier-name': colIndex = 1; break;
            case 'liters': colIndex = 4; break; // Adjusted index after removing # column
            case 'fat': colIndex = 5; break;
            case 'amount': colIndex = 6; break;
            case 'rate': colIndex = 7; break;
        }
        
        // Sort rows
        rows.sort((a, b) => {
            let aValue = a.cells[colIndex].getAttribute('data-sort-value') || 
                        a.cells[colIndex].textContent.trim();
            let bValue = b.cells[colIndex].getAttribute('data-sort-value') || 
                        b.cells[colIndex].textContent.trim();
            
            // Handle smart-numeric sorting for supplier IDs
            if (type === 'smart-numeric') {
                const aNum = parseFloat(aValue) || 0;
                const bNum = parseFloat(bValue) || 0;
                return aNum - bNum;
            }
            
            // Handle number sorting
            if (type === 'number') {
                const aNum = parseFloat(aValue) || 0;
                const bNum = parseFloat(bValue) || 0;
                return aNum - bNum;
            }
            
            // Handle text sorting
            return aValue.localeCompare(bValue);
        });
        
        // Clear and re-add sorted rows
        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
        }
        
        rows.forEach(row => {
            tbody.appendChild(row);
        });
    }
    
    // Make sortable headers clickable
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('onclick').match(/sortTable\('([^']+)'/)[1];
            const type = this.getAttribute('onclick').match(/'([^']+)'\)/)[1];
            sortTable(column, type);
        });
    });
});

function adjustColor(color, percent) {
    const num = parseInt(color.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    
    return "#" + (
        0x1000000 +
        (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)
    ).toString(16).slice(1);
}
</script>
</body>
</html>