{% extends "base_supplier.html" %}

{% block title %}My Account - Supplier {{ supplier.supplier_id }}{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-user-circle"></i> My Supplier Account</h2>

<!-- Quick Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-user text-primary"></i>
            <div class="number">{{ supplier.name }}</div>
            <div class="label">Supplier Name</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-rupee-sign text-success"></i>
            <div class="number">₹ {{ total_amount }}</div>
            <div class="label">Total Amount</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-weight text-warning"></i>
            <div class="number">{{ "%.2f"|format(total_liters) }} L</div>
            <div class="label">Total Liters</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-balance-scale {% if balance > 0 %}text-success{% else %}text-secondary{% endif %}"></i>
            <div class="number">₹ {{ balance }}</div>
            <div class="label">Current Balance</div>
        </div>
    </div>
</div>

<!-- Main Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="supplierTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active bg-info text-white" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button">
            <i class="fas fa-info-circle"></i> My Information
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link bg-success text-white" id="cycles-tab" data-bs-toggle="tab" data-bs-target="#cycles" type="button">
            <i class="fas fa-calendar-alt"></i> Collections & Payment Cycles
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link bg-warning text-dark" id="withdrawals-tab" data-bs-toggle="tab" data-bs-target="#withdrawals" type="button">
            <i class="fas fa-money-bill-wave"></i> Payment History
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="supplierTabsContent">
    
    <!-- Tab 1: Supplier Information -->
    <div class="tab-pane fade show active" id="info" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">My Information</div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <th width="120">Supplier ID:</th>
                                <td>{{ supplier.supplier_id }}</td>
                            </tr>
                            <tr>
                                <th>Name:</th>
                                <td>{{ supplier.name }}</td>
                            </tr>
                            <tr>
                                <th>Mobile:</th>
                                <td>{{ supplier.mobile or '-' }}</td>
                            </tr>
                            <tr>
                                <th>Address:</th>
                                <td>{{ supplier.address or '-' }}</td>
                            </tr>
                            <tr>
                                <th>Account Created:</th>
                                <td>{{ supplier.created_at.strftime('%d-%m-%Y') }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">Account Summary</div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="text-success fw-bold fs-4">₹ {{ total_amount }}</div>
                                <div class="text-muted small">Total Amount</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="text-primary fw-bold fs-4">{{ "%.2f"|format(total_liters) }} L</div>
                                <div class="text-muted small">Total Liters</div>
                            </div>
                            <div class="col-6">
                                <div class="text-warning fw-bold fs-4">₹ {{ total_withdrawn }}</div>
                                <div class="text-muted small">Total Paid</div>
                            </div>
                            <div class="col-6">
                                <div class="{% if balance > 0 %}text-success{% else %}text-secondary{% endif %} fw-bold fs-4">₹ {{ balance }}</div>
                                <div class="text-muted small">Current Balance</div>
                            </div>
                        </div>
                        <hr>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> This is your personal supplier portal. You can view your collections and payment history here.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 2: Collections & Payment Cycles -->
    <div class="tab-pane fade" id="cycles" role="tabpanel">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="fas fa-calendar-alt"></i> My Collections & Payment Cycles
            </div>
            <div class="card-body">
                <!-- Month Selection -->
                <form method="get" class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Select Month</label>
                        <select name="month" class="form-select">
                            <option value="">-- Select Month --</option>
                            {% for month_option in month_options %}
                            <option value="{{ month_option }}" {% if month_option == selected_month %}selected{% endif %}>
                                {{ month_option }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-search"></i> Show
                        </button>
                    </div>
                </form>

                {% if selected_month %}
                <!-- Monthly Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="compact-card bg-success text-white">
                            <div class="compact-title">Month Total</div>
                            <div class="compact-value">₹ {{ month_summary.total_amount }}</div>
                            <div class="compact-sub">{{ "%.2f"|format(month_summary.total_liters) }} L</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="compact-card bg-primary text-white">
                            <div class="compact-title">Cycle 1 (1st-15th)</div>
                            <div class="compact-value">₹ {{ cycles.cycle_1.total_amount }}</div>
                            <div class="compact-sub">{{ "%.2f"|format(cycles.cycle_1.total_liters) }} L</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="compact-card bg-info text-white">
                            <div class="compact-title">Cycle 2 (16th-end)</div>
                            <div class="compact-value">₹ {{ cycles.cycle_2.total_amount }}</div>
                            <div class="compact-sub">{{ "%.2f"|format(cycles.cycle_2.total_liters) }} L</div>
                        </div>
                    </div>
                </div>

                <!-- Cycle 1 Details -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-calendar-day"></i> Cycle 1: 1st - 15th of {{ selected_month }}
                    </div>
                    <div class="card-body p-2">
                        <div class="row text-center">
                            <div class="col-6 border-end">
                                <div class="p-2">
                                    <div class="text-warning fw-bold fs-5">₹ {{ cycles.cycle_1.morning.amount }}</div>
                                    <div class="small text-muted">Morning ({{ cycles.cycle_1.morning.count }} collections)</div>
                                    <div class="small">{{ "%.2f"|format(cycles.cycle_1.morning.liters) }} L</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2">
                                    <div class="text-info fw-bold fs-5">₹ {{ cycles.cycle_1.evening.amount }}</div>
                                    <div class="small text-muted">Evening ({{ cycles.cycle_1.evening.count }} collections)</div>
                                    <div class="small">{{ "%.2f"|format(cycles.cycle_1.evening.liters) }} L</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cycle 2 Details -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-calendar-day"></i> Cycle 2: 16th - {{ cycles.cycle_2.end.split('-')[2] }}th of {{ selected_month }}
                    </div>
                    <div class="card-body p-2">
                        <div class="row text-center">
                            <div class="col-6 border-end">
                                <div class="p-2">
                                    <div class="text-warning fw-bold fs-5">₹ {{ cycles.cycle_2.morning.amount }}</div>
                                    <div class="small text-muted">Morning ({{ cycles.cycle_2.morning.count }} collections)</div>
                                    <div class="small">{{ "%.2f"|format(cycles.cycle_2.morning.liters) }} L</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2">
                                    <div class="text-info fw-bold fs-5">₹ {{ cycles.cycle_2.evening.amount }}</div>
                                    <div class="small text-muted">Evening ({{ cycles.cycle_2.evening.count }} collections)</div>
                                    <div class="small">{{ "%.2f"|format(cycles.cycle_2.evening.liters) }} L</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Collections Table -->
                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-history"></i> My Collections for {{ selected_month }} ({{ monthly_collections|length }} entries)
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Session</th>
                                        <th>Liters</th>
                                        <th>Fat %</th>
                                        <th>Amount</th>
                                        <th>Cycle</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in monthly_collections|reverse %}
                                    <tr>
                                        <td>{{ c.date }}</td>
                                        <td>
                                            <span class="badge {% if c.session == 'morning' %}bg-warning{% else %}bg-info{% endif %}">
                                                {{ c.session|title }}
                                            </span>
                                        </td>
                                        <td>{{ "%.2f"|format(c.liters) }}</td>
                                        <td>{{ "%.1f"|format(c.fat) }}%</td>
                                        <td class="fw-bold">₹ {{ c.amount }}</td>
                                        <td>
                                            <span class="badge {% if c.date.split('-')[2]|int <= 15 %}bg-primary{% else %}bg-info{% endif %}">
                                                {% if c.date.split('-')[2]|int <= 15 %}Cycle 1{% else %}Cycle 2{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            No collections found for this month
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-light">
                                        <td colspan="4" class="text-end fw-bold">Month Total:</td>
                                        <td class="fw-bold text-success">₹ {{ month_summary.total_amount }}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Select a Month</h4>
                    <p class="text-muted">Choose a month from the dropdown to view your collections and payment cycles</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab 3: Withdrawals/Payment History -->
    <div class="tab-pane fade" id="withdrawals" role="tabpanel">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-money-bill-wave"></i> My Payment History
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for w in withdrawals|reverse %}
                            <tr>
                                <td>{{ w.date }}</td>
                                <td class="fw-bold">₹ {{ w.amount }}</td>
                                <td>{{ w.note or 'Payment received' }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center py-4 text-muted">
                                    No payment history found
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Payment Information:</strong> Payments are typically made twice a month (1st-15th and 16th-end of month).
                    Contact the admin if you have any payment-related queries.
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Compact Cards */
.compact-card {
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 15px;
}
.compact-title {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 5px;
}
.compact-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 10px 0;
}
.compact-sub {
    font-size: 0.85rem;
    opacity: 0.8;
}

/* Stat Cards */
.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
}
.stat-card i {
    font-size: 1.8rem;
    margin-bottom: 10px;
    display: block;
}
.stat-card .number {
    font-size: 1.3rem;
    font-weight: bold;
    margin: 8px 0;
}
.stat-card .label {
    font-size: 0.85rem;
    color: #6c757d;
}
</style>
{% endblock %}