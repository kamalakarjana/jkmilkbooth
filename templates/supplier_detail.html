{% extends "base.html" %}

{% block title %}Supplier - {{ supplier.name }}{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="fas fa-truck-loading"></i>
    Supplier Details: {{ supplier.supplier_id }}
</h2>

<!-- WhatsApp Status Alert -->
{% if not supplier.mobile %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle"></i> 
    <strong>No mobile number!</strong> This supplier will not receive WhatsApp notifications.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% elif not whatsapp_status %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle"></i> 
    <strong>WhatsApp not configured.</strong> 
    <a href="{{ url_for('whatsapp_status') }}" class="alert-link">Set up WhatsApp</a> to send notifications.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Quick Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-user text-primary"></i>
            <div class="number">{{ supplier.name }}</div>
            <div class="label">Supplier Name</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-rupee-sign text-success"></i>
            <div class="number">₹ {{ total_amount }}</div>
            <div class="label">Total Amount</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-weight text-warning"></i>
            <div class="number">{{ "%.2f"|format(total_liters) }} L</div>
            <div class="label">Total Liters</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-balance-scale {% if balance > 0 %}text-success{% else %}text-secondary{% endif %}"></i>
            <div class="number">₹ {{ balance }}</div>
            <div class="label">Current Balance</div>
        </div>
    </div>
</div>

<!-- WhatsApp Action Buttons -->
{% if supplier.mobile and whatsapp_status %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="fab fa-whatsapp"></i> WhatsApp Actions
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-4">
                        <a href="{{ url_for('send_daily_whatsapp', supplier_id=supplier.supplier_id) }}" 
                           class="btn btn-success w-100">
                            <i class="fab fa-whatsapp"></i> Send Today's Summary
                        </a>
                        <small class="text-muted">Send today's collection summary</small>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('send_monthly_whatsapp', supplier_id=supplier.supplier_id, month=selected_month) }}" 
                           class="btn btn-info w-100">
                            <i class="fab fa-whatsapp"></i> Send Monthly Summary
                        </a>
                        <small class="text-muted">Send summary for {{ selected_month or 'current month' }}</small>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#editSupplierModal">
                            <i class="fas fa-edit"></i> Edit Information
                        </button>
                        <small class="text-muted">Update supplier details</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Tabs -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <button class="nav-link active bg-info text-white" data-bs-toggle="tab" data-bs-target="#info">
            <i class="fas fa-info-circle"></i> Basic Info
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link bg-success text-white" data-bs-toggle="tab" data-bs-target="#collections">
            <i class="fas fa-calendar-alt"></i> Recent Collections
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link bg-warning text-dark" data-bs-toggle="tab" data-bs-target="#withdrawals">
            <i class="fas fa-money-bill-wave"></i> Withdrawals
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link bg-primary text-white" data-bs-toggle="tab" data-bs-target="#cycles">
            <i class="fas fa-chart-bar"></i> Payment Cycles
        </button>
    </li>
</ul>

<div class="tab-content">

<!-- BASIC INFO TAB -->
<div class="tab-pane fade show active" id="info">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-user"></i> Supplier Information</span>
                    <div>
                        {% if supplier.mobile and whatsapp_status %}
                        <a href="{{ url_for('send_daily_whatsapp', supplier_id=supplier.supplier_id) }}" 
                           class="btn btn-sm btn-success me-1">
                            <i class="fab fa-whatsapp"></i> Send Today
                        </a>
                        {% endif %}
                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editSupplierModal">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="30%">ID</th>
                            <td>{{ supplier.supplier_id }}</td>
                        </tr>
                        <tr>
                            <th>Name</th>
                            <td>{{ supplier.name }}</td>
                        </tr>
                        <tr>
                            <th>Mobile</th>
                            <td>
                                {% if supplier.mobile %}
                                <i class="fas fa-check-circle text-success"></i> {{ supplier.mobile }}
                                {% else %}
                                <span class="text-danger"><i class="fas fa-times-circle"></i> Not provided</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Email</th>
                            <td>
                                {% if supplier.email %}
                                <i class="fas fa-envelope text-primary"></i> {{ supplier.email }}
                                {% else %}
                                <span class="text-muted">Not provided</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Address</th>
                            <td>{{ supplier.address or '-' }}</td>
                        </tr>
                        <tr>
                            <th>WhatsApp Status</th>
                            <td>
                                {% if supplier.mobile and whatsapp_status %}
                                <span class="badge bg-success">Active</span>
                                <small class="text-muted">Ready to send notifications</small>
                                {% elif not supplier.mobile %}
                                <span class="badge bg-warning">No Mobile</span>
                                <small class="text-muted">Add mobile number for WhatsApp</small>
                                {% else %}
                                <span class="badge bg-secondary">Not Configured</span>
                                <small class="text-muted"><a href="{{ url_for('whatsapp_status') }}">Set up WhatsApp</a></small>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- FINANCIAL SUMMARY -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-chart-line"></i> Financial Summary
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-4">
                            <div class="display-6 text-success">₹ {{ total_amount }}</div>
                            <small class="text-muted">Total Collections</small>
                        </div>
                        <div class="col-6 mb-4">
                            <div class="display-6 text-primary">{{ "%.2f"|format(total_liters) }} L</div>
                            <small class="text-muted">Total Liters</small>
                        </div>
                        <div class="col-6">
                            <div class="display-6 text-warning">₹ {{ total_withdrawn }}</div>
                            <small class="text-muted">Total Withdrawn</small>
                        </div>
                        <div class="col-6">
                            <div class="display-6 {% if balance > 0 %}text-success{% else %}text-secondary{% endif %}">
                                ₹ {{ balance }}
                            </div>
                            <small class="text-muted">Current Balance</small>
                        </div>
                    </div>
                    
                    <!-- Monthly Summary -->
                    {% if selected_month %}
                    <hr>
                    <h6>Monthly Summary ({{ selected_month }})</h6>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold">₹ {{ month_summary.total_amount }}</div>
                            <small class="text-muted">Month Collections</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold">₹ {{ month_summary.total_withdrawn }}</div>
                            <small class="text-muted">Month Withdrawals</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- COLLECTIONS TAB -->
<div class="tab-pane fade" id="collections">
    <div class="card">
        <div class="card-header bg-success text-white">
            <i class="fas fa-history"></i> Recent Collections (Last 50)
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Session</th>
                            <th>Liters</th>
                            <th>Fat</th>
                            <th>Type</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in collections %}
                        <tr>
                            <td>{{ c.date }}</td>
                            <td>
                                <span class="badge {% if c.session == 'morning' %}bg-primary{% else %}bg-info{% endif %}">
                                    {{ c.session }}
                                </span>
                            </td>
                            <td>{{ c.liters }}</td>
                            <td>{{ c.fat }}</td>
                            <td>{{ c.milk_type }}</td>
                            <td>₹{{ c.rate_per_liter }}</td>
                            <td class="fw-bold">₹{{ c.amount }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">No collections found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- WITHDRAWALS TAB -->
<div class="tab-pane fade" id="withdrawals">
    <div class="card">
        <div class="card-header bg-warning text-dark">
            <i class="fas fa-money-bill-wave"></i> Withdrawals
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for w in withdrawals %}
                        <tr>
                            <td>{{ w.date }}</td>
                            <td class="fw-bold text-danger">- ₹ {{ w.amount }}</td>
                            <td>{{ w.note or '-' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center text-muted">No withdrawals</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- PAYMENT CYCLES TAB -->
<div class="tab-pane fade" id="cycles">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-chart-bar"></i> Payment Cycles
        </div>
        <div class="card-body">
            <!-- Month Selection -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <form method="GET" class="row g-3">
                        <div class="col-md-8">
                            <select name="month" class="form-select" onchange="this.form.submit()">
                                <option value="">Select Month</option>
                                {% for month in month_options %}
                                <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>
                                    {{ month }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('supplier_view', supplier_id=supplier.supplier_id) }}" 
                               class="btn btn-secondary w-100">Clear</a>
                        </div>
                    </form>
                </div>
            </div>

            {% if selected_month and cycles %}
            <!-- Cycle 1: 1st-15th -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    Cycle 1: {{ cycles.cycle_1.start }} to {{ cycles.cycle_1.end }}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Morning</h6>
                            <p>Liters: {{ cycles.cycle_1.morning.liters }}<br>
                               Amount: ₹{{ cycles.cycle_1.morning.amount }}<br>
                               Count: {{ cycles.cycle_1.morning.count }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Evening</h6>
                            <p>Liters: {{ cycles.cycle_1.evening.liters }}<br>
                               Amount: ₹{{ cycles.cycle_1.evening.amount }}<br>
                               Count: {{ cycles.cycle_1.evening.count }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <h5>Cycle 1 Total: ₹{{ cycles.cycle_1.total_amount }} ({{ cycles.cycle_1.total_liters }} liters)</h5>
                    </div>
                </div>
            </div>

            <!-- Cycle 2: 16th-End -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    Cycle 2: {{ cycles.cycle_2.start }} to {{ cycles.cycle_2.end }}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Morning</h6>
                            <p>Liters: {{ cycles.cycle_2.morning.liters }}<br>
                               Amount: ₹{{ cycles.cycle_2.morning.amount }}<br>
                               Count: {{ cycles.cycle_2.morning.count }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Evening</h6>
                            <p>Liters: {{ cycles.cycle_2.evening.liters }}<br>
                               Amount: ₹{{ cycles.cycle_2.evening.amount }}<br>
                               Count: {{ cycles.cycle_2.evening.count }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <h5>Cycle 2 Total: ₹{{ cycles.cycle_2.total_amount }} ({{ cycles.cycle_2.total_liters }} liters)</h5>
                    </div>
                </div>
            </div>

            <!-- Month Summary -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-chart-pie"></i> Month Summary: {{ selected_month }}
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="display-6 text-success">₹{{ month_summary.total_amount }}</div>
                            <small class="text-muted">Total Collections</small>
                        </div>
                        <div class="col-md-3">
                            <div class="display-6 text-primary">{{ month_summary.total_liters }} L</div>
                            <small class="text-muted">Total Liters</small>
                        </div>
                        <div class="col-md-3">
                            <div class="display-6 text-danger">₹{{ month_summary.total_withdrawn }}</div>
                            <small class="text-muted">Total Withdrawn</small>
                        </div>
                        <div class="col-md-3">
                            <div class="display-6 {% if month_summary.balance > 0 %}text-success{% else %}text-secondary{% endif %}">
                                ₹{{ month_summary.balance }}
                            </div>
                            <small class="text-muted">Month Balance</small>
                        </div>
                    </div>
                    
                    <!-- WhatsApp Action for Month -->
                    {% if supplier.mobile and whatsapp_status %}
                    <div class="mt-4 text-center">
                        <a href="{{ url_for('send_monthly_whatsapp', supplier_id=supplier.supplier_id, month=selected_month) }}" 
                           class="btn btn-success btn-lg">
                            <i class="fab fa-whatsapp"></i> Send Monthly Summary via WhatsApp
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% elif selected_month %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No collections found for {{ selected_month }}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Select a month above to view payment cycles
            </div>
            {% endif %}
        </div>
    </div>
</div>

</div>

<!-- Action Buttons -->
<div class="mt-4 d-flex justify-content-between">
    <div>
        <a href="{{ url_for('suppliers') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Suppliers
        </a>
        <a href="{{ url_for('add_collection_page') }}?supplier_id={{ supplier.supplier_id }}" 
           class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Collection
        </a>
    </div>
    <div>
        {% if supplier.mobile and whatsapp_status %}
        <a href="{{ url_for('send_daily_whatsapp', supplier_id=supplier.supplier_id) }}" 
           class="btn btn-success">
            <i class="fab fa-whatsapp"></i> Send Today's WhatsApp
        </a>
        {% endif %}
        <a href="{{ url_for('whatsapp_dashboard') }}" class="btn btn-info">
            <i class="fas fa-tachometer-alt"></i> WhatsApp Dashboard
        </a>
    </div>
</div>

<!-- EDIT SUPPLIER MODAL -->
<div class="modal fade" id="editSupplierModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('edit_supplier', supplier_id=supplier.supplier_id) }}">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-edit"></i> Edit Supplier Information
                    </h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Supplier ID</label>
                        <input type="text" class="form-control" value="{{ supplier.supplier_id }}" readonly>
                        <small class="text-muted">Supplier ID cannot be changed</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" name="name" class="form-control" value="{{ supplier.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mobile *</label>
                        <input type="text" name="mobile" class="form-control" value="{{ supplier.mobile }}" required>
                        <small class="text-muted">Required for WhatsApp notifications</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email (Optional)</label>
                        <input type="email" name="email" class="form-control" value="{{ supplier.email }}">
                        <small class="text-muted">For email communications</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control" rows="3">{{ supplier.address }}</textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-warning">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
